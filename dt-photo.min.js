(function(b){var D=0;b.fn.DTPhoto=function(e){var k=function(){b("#dt-photo-ajax-loader").remove();var d=b('<div id="dt-photo-ajax-loader"></div>'),e=b('<img src="'+a.loaderImg+'">');d.append(e);b("body").append(d)},u=function(){b("#dt-photo-image-"+a.id).remove();var d=b('<img class="dt-photo-image" id="dt-photo-image-'+a.id+'" src="'+a.currentImage+'">').css({width:a.width+"px",height:a.height+"px"});a.obj.append(d)},n=function(d){var e=function(a){27==a.keyCode?(g.empty(),g.remove(),k.remove(),
y.val(""),b(document).off("keyup",e)):13==a.keyCode&&z.click()};b("#dt-photo-ajax-loader").remove();var l=JSON.parse(d);if("undefined"!==typeof l.error)a.obj.append('<div class="dt-photo-upload-error">'+a.uploadErrorMsg+"</div>");else{var k=b('<div class="dt-photo-preview-background"></div>'),g=b('<div class="dt-photo-preview-container"></div>'),c=b.fn.DTPhoto.calculateScale(a.previewWidth,a.previewHeight,l.width,l.height);g.css({width:c.width+"px",height:c.height+"px",marginLeft:-(c.width/2)+"px",
marginTop:-(c.height/2)+"px"});var n=b('<img src="'+l.name+'" class="dt-photo-preview-image">').css({width:c.width+"px",height:c.height+"px"});g.append(n);d=Math.round(a.width*c.k);var m=Math.round(a.height*c.k);if(d>c.width||m>c.height){var f=Math.max(d/c.width,m/c.height);d/=f;m/=f}var h=b('<div class="dt-photo-select-square"></div>').css({width:d+"px",height:m+"px",left:c.width/2-d/2+"px",top:c.height/2-m/2+"px"}),f=b('<div class="dt-photo-scale-square"></div>');h.append(f);var q,r;q=0;r=-(c.height-
(c.height/2-m/2));var t=b('<div class="dt-photo-square-bg"></div>').css({left:q+"px",top:r+"px",width:c.width+"px",height:c.height+"px"});g.append(t);q=-(c.width-(c.width/2-d/2));r=0;var v=b('<div class="dt-photo-square-bg"></div>').css({left:q+"px",top:r+"px",width:c.width+"px",height:c.height+"px"});g.append(v);q=c.width/2+d/2;r=0;var w=b('<div class="dt-photo-square-bg"></div>').css({left:q+"px",top:r+"px",width:c.width+"px",height:c.height+"px"});g.append(w);q=0;r=c.height/2+m/2;var x=b('<div class="dt-photo-square-bg"></div>').css({left:q+
"px",top:r+"px",width:c.width+"px",height:c.height+"px"});g.append(x);g.append(h);var z=b('<button class="dt-photo-preview-button">'+a.saveButtonText+"</button>");g.append(z);b("body").append(k);b("body").append(g);moveS1=moveSquare=!1;z.on("click",function(){var d=n.prop("src");n.remove();var E=b('<img class="dt-photo-loader" src="'+a.loaderImg+'">');h.append(E);var p=h.clone(),F=h.offset(),A=parseFloat(h.css("left").replace("px","")),f=parseFloat(h.css("top").replace("px","")),k=p.innerWidth(),
m=p.innerHeight();p.css({backgroundImage:"URL('"+d+"')",backgroundSize:c.width+"px "+c.height+"px",backgroundPosition:"-"+A+"px -"+f+"px",left:F.left+"px",top:F.top+"px",border:"0"});b("body").append(p);h.remove();g.hide();A/=c.k;f/=c.k;k/=c.k;m/=c.k;b.post(a.action,{f:l.name,"upload-type":"save",l:A,t:f,w:k,h:m,rw:a.width,rh:a.height},function(c){if("undefined"!==typeof c.error)console.log(c.error);else{var d=a.obj.offset();b('<img src="'+c.src+'">').on("load",function(){E.remove();var h=b('<img src="'+
c.src+'">').css({width:p.width()+"px",height:p.height()+"px",position:"absolute",left:p.offset().left+"px",top:p.offset().top+"px"});b("body").append(h);p.remove();h.animate({top:d.top,left:d.left,width:a.width,height:a.height},600,"swing",function(){a.currentImage=c.src;u();e({keyCode:27});b(this).remove()})})}},"json")});h.on({dblclick:function(){z.click()},mousedown:function(a){moveSquare={x:a.pageX,y:a.pageY}},mousemove:function(a){if(moveSquare&&!moveS1){var b=a.pageX-moveSquare.x,c=a.pageY-
moveSquare.y,d=parseFloat(h.css("top").replace("px",""))+c,e=parseFloat(h.css("left").replace("px",""))+b;0<=d&&d+h.outerHeight()<g.innerHeight()&&(h.css("top",d+"px"),t.css("top",parseFloat(t.css("top").replace("px",""))+c+"px"),x.css("top",parseFloat(x.css("top").replace("px",""))+c+"px"));0<=e&&e+h.outerWidth()<g.innerWidth()&&(h.css("left",e+"px"),v.css("left",parseFloat(v.css("left").replace("px",""))+b+"px"),w.css("left",parseFloat(w.css("left").replace("px",""))+b+"px"));moveSquare.x=a.pageX;
moveSquare.y=a.pageY}},mouseup:function(){moveS1=moveSquare=!1}});f.on("mousedown",function(a){moveS1={x:a.pageX,y:a.pageY}});k.on("mouseup",function(){moveS1=moveSquare=!1});var B=parseFloat(h.css("width").replace("px","")),C=parseFloat(h.css("height").replace("px",""));g.on({mousemove:function(b){if(moveS1){var d=b.pageX-moveS1.x,e=b.pageY-moveS1.y,f=d,g=e;a.fixedRatio&&(Math.abs(d)>=Math.abs(e)?g=f/(a.width/a.height):f=g/(a.height/a.width));d=parseFloat(x.css("top").replace("px",""))+g;e=parseFloat(w.css("left").replace("px",
""))+f;d<c.height&&e<c.width&&(5<C+g&&(h.css("height",C+g+"px"),x.css("top",d+"px"),C+=g),5<B+f&&(h.css("width",B+f+"px"),w.css("left",e+"px"),B+=f));moveS1.x=b.pageX;moveS1.y=b.pageY}},mouseup:function(a){moveS1=moveSquare=!1}});b(document).on("keyup",e)}};D++;e.id=D;var a=b.extend({},b.fn.DTPhoto.defaults,e);a.obj=this;a.obj.css({width:a.width+"px",height:a.height+"px",overflow:"hidden"});"static"==a.obj.css("position")&&a.obj.css("position","relative");var l=b('<div class="dt-photo-upload-container"></div>').css({display:"none",
width:a.width+"px",height:a.height+"px"});a.useUploadButton&&(e=b('<div class="dt-photo-upload-bg"></div>').css({width:a.width+"px",height:a.height+"px"}),l.append(e));var t=b('<form action="'+a.action+'" target="dt-photo-upload-iframe-'+a.id+'" method="post" enctype="multipart/form-data" class="dt-photo-upload-form"></form>'),y=b('<input name="dt-photo-upload-file" id="dt-photo-upload-file-'+a.id+'" type="file" accept="image/*">'),v=b('<input name="upload-type" type="hidden" value="load">');t.append(v).append(y);
l.append(t);e=b('<iframe class="dt-photo-upload-iframe" name="dt-photo-upload-iframe-'+a.id+'" id="dt-photo-upload-iframe-'+a.id+'"></iframe>');l.append(e);if(a.useUploadButton){var f=b('<button class="dt-photo-upload-button" id="dt-photo-upload-button-'+a.id+'">'+a.uploadButtonText+"</button>");l.append(f);a.uploadButton=f}null!==a.currentImage&&u();""==a.obj.css("position")&&a.obj.css("position","relative");a.obj.append(l);if(a.useUploadButton)a.obj.on({mouseover:function(){l.css("display","block");
f.css({marginTop:-Math.round(f.outerHeight()/2)+"px",marginLeft:-Math.round(f.outerWidth()/2)+"px"})},mouseout:function(){l.css("display","none")}});a.uploadButton.on("click",function(){b(".dt-photo-upload-error").remove();v.val("load");y.click()});y.on("change",function(){var b=this.files[0];"undefined"!==typeof b&&b?b.size>a.maxFileSize?a.obj.append('<div class="dt-photo-upload-error">'+a.maxFileSizeOverheadMsg+"</div>"):(k(),t.submit()):(k(),t.submit())});e.on("load",function(){"load"==v.val()&&
n(b(this).contents().find("body").text())})};b.fn.DTPhoto.defaults={obj:null,width:300,height:140,fixedRatio:!0,action:null,useUploadButton:!0,uploadButton:null,uploadButtonText:"Upload",saveButtonText:"Save",currentImage:null,maxFileSize:1048576,maxFileSizeOverheadMsg:"File is too big. Maximum size is 1 MB.",uploadErrorMsg:"Upload error. try again",previewWidth:600,previewHeight:500,loaderImg:"/img/white-loader.gif",id:0};b.fn.DTPhoto.calculateScale=function(b,k,u,n){var a;a=Math.min(u<b?1:b/u,n<
k?1:k/n);kMax=Math.max(b/u,k/n);return{width:u*a,height:n*a,k:a,kMax:kMax}}})(jQuery);
